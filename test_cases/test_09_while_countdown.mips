.data
string_buffer: .space 1024
string_buffer_size: .half 1024
stoi_overflow_str: .asciiz "Erro: overflow na funcao stoi (conversao de string para int)!\n"

pow_overflow_str: .asciiz "Erro: overflow na funcao exponencial!\n"
pow_negative_exp_str: .asciiz "Erro: expoente negativo na funcao exponencial!\n"
float_zero: .float 0.0
float_one: .float 1.0
float_ten: .float 10.0
true_string: .asciiz "TRUE"
false_string: .asciiz "FALSE"

.text
    main:
move $fp, $sp
li $t1, 5
move $t0, $t1
li $t1, 0
move $t2, $t1
label0:
li $t1, 0
move $t3, $t0
bge $t1, $t3, label2
label1:
move $t2, $t0
move $t1, $t0
li $t3, 1
sub $t0, $t1, $t3
j label0
label2:
move $t3, $t2
move $a0, $t3
jal itos
move $t1, $v0
li $v0, 4
move $a0, $t1
syscall
jal put_line
j program_end

    concat:
addi $sp, $sp, -16
bne $a3, $0, concat_get_values
li $a0, 64
li $v0, 9
syscall
addi $v0, $v0, 8
move $a1, $v0
move $a3, $v0
j concat_already_initialized
    concat_get_values:
lw $a0, -8($a3)
lw $a1, -4($a3)
    concat_already_initialized:
lb $v1, 0($a2)
sb $v1, 0($a1)
addi $a2, $a2, 1
addi $a1, $a1, 1
sub $v0, $a1, $a3
bne $v0, $a0, concat_buffer_not_full
sll $a0, $a0, 1
sw $v1, 4($sp)
sw $a2, 8($sp)
sw $v0, 12($sp)
li $v0, 9
syscall
move $a2, $a3
addi $v0, $v0, 8
    concat_transfer_buffer:
lb $v1, 0($a2)
sb $v1, 0($v0)
addi $a2, $a2, 1
addi $v0, $v0, 1
bne $a2, $a1, concat_transfer_buffer
lw $v1, 4($sp)
lw $a2, 8($sp)
lw $v0, 12($sp)
    concat_buffer_not_full:
bne $v1, $0, concat_already_initialized
subi $a1, $a1, 1
addi $sp, $sp, 16
sw $a0, -8($a3)
sw $a1, -4($a3)
jr $ra

    dynamic_str_compare_eq:
lb $a2, 0($a0)
lb $a3, 0($a1)
addi $a0, $a0, 1
addi $a1, $a1, 1
bne $a2, $a3, dynamic_str_compare_eq_not_equal
bne $a2, $0, dynamic_str_compare_eq
li $v0, 1
j dynamic_str_compare_eq_end
    dynamic_str_compare_eq_not_equal:
li $v0, 0
    dynamic_str_compare_eq_end:
jr $ra

    static_str_compare_eq:
addi $sp, $sp, -12
sw $s0, 4($sp)
sw $s1, 8($sp)
lw $a2, 0($a0)
lw $a3, 0($a1)
addi $a0, $a0, 4
addi $a1, $a1, 4
j static_str_compare_eq_loop
    static_str_compare_eq_next1:
lw $a2, 0($a0)
addi $a0, $a0, 4
addi $s1, $s1, -1
bne $a2, $0, static_str_compare_eq_loop
li $v0, 0
j static_str_compare_eq_end
    static_str_compare_eq_next2:
lw $a3, 0($a1)
addi $a1, $a1, 4
addi $s0, $s0, -1
bne $a3, $0, static_str_compare_eq_loop
li $v0, 0
j static_str_compare_eq_end
    static_str_compare_eq_next3:
lw $a2, 0($a0)
lw $a3, 0($a1)
addi $a0, $a0, 4
addi $a1, $a1, 4
seq $v0, $a2, $0
seq $v1, $a3, $0
or $v1, $v0, $v1
li $v0, 0
beq $v1, $0, static_str_compare_eq_loop
bne $a2, $a3, static_str_compare_eq_end
li $v0, 1
j static_str_compare_eq_end
    static_str_compare_eq_loop:
lb $s0, 0($a2)
lb $s1, 0($a3)
addi $a2, $a2, 1
addi $a3, $a3, 1
seq $v0, $s0, $0
seq $v1, $s1, $0
or $v1, $v0, $v1
bne $v1, $0, static_str_compare_eq_null
beq $s0, $s1, static_str_compare_eq_loop
li $v0, 0
j static_str_compare_eq_end
    static_str_compare_eq_null:
beq $s0, $s1, static_str_compare_eq_next3
beq $s0, $0, static_str_compare_eq_next1
j static_str_compare_eq_next2
    static_str_compare_eq_end:
lw $s0, 4($sp)
lw $s1, 8($sp)
addi $sp, $sp, 12
jr $ra

    read:
addi $sp, $sp, -24
sw $a2, 4($sp)
sw $a3, 8($sp)
sw $0, 12($sp)
li $a2, 10
li $a3, 0
    read_start:
la $a0, string_buffer
lh $a1, string_buffer_size
li $v0, 8
syscall
move $a1, $a0
    read_check_size:
lb $v1, 0($a0)
addi $a0, $a0, 1
bne $v1, $0, read_check_size
sub $v1, $a0, $a1
li $v0, 9
move $a0, $v1
syscall
sub $v0, $v0, $a3
    read_move_to_heap:
lb $a0, 0($a1)
sb $a0, 0($v0)
addi $a1, $a1, 1
addi $v0, $v0, 1
bne $a0, $0, read_move_to_heap
lw $a0, 12($sp)
bne $a0, $0, read_not_first
sub $a3, $v0, $v1
sw $a3, 16($sp)
li $a3, 0
    read_not_first:
add $a0, $a0, $v1
subi $a0, $a0, 1
sw $a0, 12($sp)
lb $a0, -2($v0)
sw $a3 20($sp)
addi $a3, $v1, 3
sra $a3, $a3, 2
sll $a3, $a3, 2
addi $a3, $a3, 1
sub $a3, $a3, $v1
lw $v1, 20($sp)
add $a3, $a3, $v1
bne $a0, $a2, read_start
sb $0, -2($v0)
lw $a3, 16($sp)
move $v0, $a3
lw $v1, 12($sp)
lw $a2, 4($sp)
lw $a3, 8($sp)
subi $v1, $v1, 1
sw $v0, 0($a2)
sw $v1, 0($a3)
addi $sp, $sp, 24
jr $ra

    put_line:
la $a0, string_buffer
li $a1, 10
sw $a1, 0($a0)
li $v0, 4
syscall
jr $ra

    itos:
move $a1, $a0
move $v1, $a0
li $v0, 9
li $a0, 12
syscall
li $a2, 10
addi $v0, $v0, 10
sb $0, 1($v0)
    itos_convert:
div $a1, $a2
mflo $a1
mfhi $a3
addi $a3, $a3, 48
sb $a3, 0($v0)
addi $v0, $v0, -1
bne $a1, $0, itos_convert
bge $v1, $0, itos_positive
li $a0, 45
sb $a0, 0($v0)
j itos_negative
    itos_positive:
addi $v0, $v0, 1
    itos_negative:
jr $ra

    ftos:
addi $sp, $sp, -40
sw $ra, 4($sp)
li $a3, 0
sw $a3, 8($sp)
li $v1, 1
l.s $f13 float_zero
c.lt.s $f12, $f13
bc1f ftos_count_integer_size
li $v1, 0
neg.s $f12, $f12
    ftos_count_integer_size:
l.s $f14, float_ten
l.s $f1, float_one
addi $a3, $a3, 1
div.s $f12, $f12, $f14
c.lt.s $f12, $f1
bc1f ftos_count_integer_size
    ftos_restart_integer_extraction:
mul.s $f12, $f12, $f14
addi $a3, $a3, -1
cvt.w.s $f0, $f12
mfc1 $a1, $f0
li $a0, 4
li $v0, 9
syscall
addi $a1, $a1, 48
sb $a1, 0($v0)
sb $0, 1($v0)
sw $a3, 12($sp)
move $a2, $v0
lw $a1, 16($sp)
lw $a3, 8($sp)
bne $a3, $0, ftos_positive
bne $v1, $0, ftos_positive
li $v1, 45
lb $a1, 0($a2)
sb $v1, 0($a2)
sb $a1, 1($a2)
sb $0, 2($a2)
    ftos_positive:
jal concat
sw $a1, 16($sp)
sw $a3, 8($sp)
lw $a3, 12($sp)
cvt.s.w $f0, $f0
sub.s $f12, $f12, $f0
bne $a3, $0, ftos_restart_integer_extraction
sw $a0, 20($sp)
mov.s $f13, $f12
l.s $f0, float_ten
li $a2, 0
li $a3, 9
    ftos_count_leading_zeros:
mul.s $f13, $f13, $f0
beq $a3, $0, ftos_end_leading_zeros
addi $a2, $a2, 1
addi $a3, $a3, -1
c.lt.s $f13, $f1
bc1t ftos_count_leading_zeros
addi $a2, $a2, -1
addi $a3, $a3, 1
    ftos_end_leading_zeros:
li $v0, 9
li $a0, 12
li $v1, 48
syscall
move $a0, $a2
move $a3, $v0
li $a1, 0
beq $a2, $0, ftos_no_zeros
    ftos_add_zeros:
sb $v1, 0($v0)
addi $v0, $v0, 1
addi $a2, $a2, -1
addi $a1, $a1, 1
bgt $a2, $0, ftos_add_zeros
    ftos_no_zeros:
sw $a1, 32($sp)
sw $a3, 36($sp)
sb $0, 0($v0)
lw $a1, 16($sp)
lw $a3, 8($sp)
li $v0, 9
li $a0, 4
syscall
li $a0, 46
sb $a0, 0($v0)
sb $0, 1($v0)
move $a2, $v0
lw $a0, 20($sp)
jal concat
lw $a2, 36($sp)
jal concat
sw $a0, 20($sp)
sw $a1, 16($sp)
sw $a3, 8($sp)
lw $v1, 32($sp)
srl $v1, $v1, 3
neg $v1, $v1
add $v1, $v1, 9
l.s $f0, float_ten
l.s $f14, float_one
beq $v1, $0, ftos_mult_number_equals_one
    ftos_get_mult_number:
mul.s $f14, $f14, $f0
addi $v1, $v1, -1
bne $v1, $0, ftos_get_mult_number
    ftos_mult_number_equals_one:
mul.s $f12, $f12, $f14
cvt.w.s $f12, $f12
mfc1 $a0, $f12
beq $a0, $0, ftos_end
jal itos
move $a2, $v0
lw $a0, 20($sp)
lw $a1, 16($sp)
lw $a3, 8($sp)
jal concat
sw $a3, 8($sp)
    ftos_end:
lw $a3, 8($sp)
move $v0, $a3
lw $ra, 4($sp)
addi $sp, $sp, 40
jr $ra

    stoi:
addi $sp, $sp, -4
li $v0, 1
sw $v0, 0($sp)
li $v0, 0
li $a2, 10
li $a3, 32
li $v1, 10
    stoi_first_phase:
lb $a1, 0($a0)
addi $a0, $a0, 1
beq $a1, $a2, stoi_first_phase
beq $a1, $a3, stoi_first_phase
li $a2, 45
bne $a1, $a2, stoi_positive
sw $0, 0($sp)
lb $a1, 0($a0)
addi $a0, $a0, 1
    stoi_positive:
li $a2, 48
li $a3, 57
beq $a1, $0, program_end
    stoi_second_phase:
beq $a1, $0, stoi_end
blt $a1, $a2, stoi_end_second_phase
bgt $a1, $a3, stoi_end_second_phase
mult $v0, $v1
mfhi $v0
bne $v0, $0, stoi_overflow
mflo $v0
blt $v0, $0, stoi_overflow
lw $a2, 0($sp)
bne $a2, $0, stoi_positive_second_phase
li $a2, 48    
addi $a1, $a1, -48
sub $v0, $v0, $a1
lb $a1, 0($a0)
addi $a0, $a0, 1
j stoi_second_phase
    stoi_positive_second_phase:
li $a2, 48    
addi $a1, $a1, -48
add $v0, $v0, $a1
lb $a1, 0($a0)
addi $a0, $a0, 1
j stoi_second_phase
    stoi_end_second_phase:
li $a2, 10
li $a3, 32
beq $v0, $0, program_end
    stoi_third_phase:
lb $a1, 0($a0)
addi $a0, $a0, 1
beq $a1, $a2, stoi_third_phase
beq $a1, $a3, stoi_third_phase
beq $a1, $0, stoi_end
j program_end
    stoi_end:
lw $a0, 0($sp)
addi $sp, $sp, 4
jr $ra

    btos:
beq $a0, $0, btos_false
la $v0, true_string
j btos_true
    btos_false:
la $v0, false_string
    btos_true:
jr $ra

    pow_int:
addi $sp, $sp, -12
sw $fp, 8($sp)
move $fp, $sp
li $v0, -2
li $v1, 31
bne $v0, $a0, pow_int_negative_max
bne $v1, $a1, pow_int_negative_max
li $v0, 0x80000000
j pow_int_end
    pow_int_negative_max:
li $v0, 1
li $v1, 1
beq $a1, $0, pow_int_end
bge $a1, $0, pow_int_non_negative_exp
li $v0, 4
la $a0, pow_negative_exp_str
syscall
j program_end
    pow_int_non_negative_exp:
beq $a0, $0, pow_int_end
and $a3, $a1, $v0
bge $a0, $0, pow_int_positive
sub $a0, $0, $a0
addiu $a3, $a3, 1
    pow_int_positive:
srl $a3, $a3, 1
beq $a0, $v0, pow_int_end
    pow_int_heatup:
sw $a0, 4($sp)
subiu $sp, $sp, 4
mult $a0, $a0
sll $v1, $v1, 1
mfhi $a2
mflo $a0
bne $a2, $0, pow_int_cooldown_further
blt $a0, $0, pow_int_cooldown_further
blt $v1, $a1, pow_int_heatup
bne $v1, $a1, pow_int_cooldown_further
    pow_int_cooldown:
mult $v0, $a0
mfhi $a2
mflo $v0
bne $a2, $0, pow_overflow
blt $v0, $0, pow_overflow
sub $a1, $a1, $v1
beq $a1, $0, pow_int_end
    pow_int_cooldown_further:
srl $v1, $v1, 1
addiu $sp, $sp, 4
beq $v1, $0, pow_overflow
bgt $v1, $a1, pow_int_cooldown_further
lw $a0, 4($sp)
j pow_int_cooldown
    pow_int_end:
beq $a3, $0, pow_int_end_positive
sub $v0, $0, $v0
    pow_int_end_positive:
move $sp, $fp
lw $fp, 8($sp)
addi $sp, $sp, 12
jr $ra

    pow_float:
addi $sp, $sp, -12
sw $fp, 8($sp)
move $fp, $sp
lwc1 $f0, float_one
li $v1, 1
beq $a1, $0, pow_float_end_positive
bge $a1, $0, pow_float_non_negative_exp
div.s $f12, $f0, $f12
sub $a1, $0, $a1
    pow_float_non_negative_exp:
lwc1 $f1, float_zero
c.eq.s $f12, $f1
mov.s $f0, $f12
bc1t pow_float_end_positive
lwc1 $f0, float_one
li $v0, 1
and $a3, $a1, $v0
c.lt.s $f12, $f1
bc1f pow_float_positive
neg.s $f12, $f12
addiu $a3, $a3, 1
    pow_float_positive:
srl $a3, $a3, 1
c.eq.s $f12, $f0
bc1t pow_float_end
    pow_float_heatup:
s.s $f12, 4($sp)
subiu $sp, $sp, 4
mul.s $f12, $f12, $f12
sll $v1, $v1, 1
mfc1 $a2, $f12
li $v0, 0x7F800000
beq $a2, $v0, pow_float_cooldown_further
li $v0, 0xFF800000
beq $a2, $v0, pow_float_cooldown_further
li $v0, 0xFF000000
and $a2, $a2, $v0
bne $a2, $v0, pow_float_valid_1
mfc1 $v0, $f12
li $a2, 0x00FFFFFF
and $v0, $v0, $a2
beq $v0, $0, pow_float_valid_1
j pow_overflow
    pow_float_valid_1:
blt $v1, $a1, pow_float_heatup
bne $v1, $a1, pow_float_cooldown_further
    pow_float_cooldown:
mul.s $f0, $f0, $f12
mfc1 $a2, $f0
li $v0, 0x7F800000
beq $a2, $v0, pow_overflow
li $v0, 0xFF800000
beq $a2, $v0, pow_overflow
li $v0, 0xFF000000
and $a2, $a2, $v0
bne $a2, $v0, pow_float_valid_2
mfc1 $v0, $f0
li $a2, 0x00FFFFFF
and $v0, $v0, $a2
beq $v0, $0, pow_float_valid_2
j pow_overflow
    pow_float_valid_2:
sub $a1, $a1, $v1
beq $a1, $0, pow_float_end
    pow_float_cooldown_further:
srl $v1, $v1, 1
addiu $sp, $sp, 4
beq $v1, $0, pow_overflow
bgt $v1, $a1, pow_float_cooldown_further
l.s $f12, 4($sp)
j pow_float_cooldown
    pow_float_end:
beq $a3, $0, pow_float_end_positive
neg.s $f0, $f0
    pow_float_end_positive:
move $sp, $fp
lw $fp, 8($sp)
addi $sp, $sp, 12
jr $ra

    stoi_overflow:
li $v0, 4
la $a0, stoi_overflow_str
syscall
j program_end

    pow_overflow:
li $v0, 4
la $a0, pow_overflow_str
syscall
j program_end

    program_end:
li $v0, 10
syscall